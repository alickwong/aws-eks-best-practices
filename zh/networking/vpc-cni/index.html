
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../subnets/">
      
      
        <link rel="next" href="../ip-optimization-strategies/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>Amazon VPC CNI - EKS 最佳实践</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.bcfcd587.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-VQGL8B2FH8"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-VQGL8B2FH8",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-VQGL8B2FH8",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#amazon-vpc-cni" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../" title="EKS 最佳实践" class="md-header__button md-logo" aria-label="EKS 最佳实践" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EKS 最佳实践
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Amazon VPC CNI
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="选择当前语言">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24Z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="../../../networking/vpc-cni/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="./" hreflang="zh" class="md-select__link">
              Chinese
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../../ko/networking/vpc-cni/" hreflang="ko" class="md-select__link">
              한국어
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws/aws-eks-best-practices" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../" title="EKS 最佳实践" class="md-nav__button md-logo" aria-label="EKS 最佳实践" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    EKS 最佳实践
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws/aws-eks-best-practices" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    指南
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            指南
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    简介
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    安全
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            安全
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/iam/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    身份和访问管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/pods/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pod 安全
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/multitenancy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    多租户
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/detective/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    侦测控制
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/network/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    网络安全
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    数据加密和机密管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/runtime/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    运行时安全
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/hosts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    基础设施安全
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/compliance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    合规性
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/incidents/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    事件响应和取证
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/image/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    镜像安全
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/multiaccount/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multi Account Strategy
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    集群自动扩展
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            集群自动扩展
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../karpenter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Karpenter
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cluster-autoscaling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    集群自动扩展器
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    可靠性
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            可靠性
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reliability/docs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reliability/docs/application/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    应用程序
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reliability/docs/controlplane/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    控制平面
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reliability/docs/dataplane/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    数据平面
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Windows 容器
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Windows 容器
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/ami/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AMI 管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/gmsa/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows 容器的 gMSA
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/hardening/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows 服务器加固
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/images/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    扫描 Windows 镜像
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/licensing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows 版本和许可
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/logging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    日志记录
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/monitoring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    监控 Windows 容器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows 网络
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/oom/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    内存和系统管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/patching/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    基础设施管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/scheduling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    调度
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/security/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows 容器的 Pod 安全
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    存储选项
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    网络
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            网络
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../subnets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VPC 和子网注意事项
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Amazon VPC CNI
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Amazon VPC CNI
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      概述
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      建议
    </span>
  </a>
  
    <nav class="md-nav" aria-label="建议">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vpc-cni" class="md-nav__link">
    <span class="md-ellipsis">
      部署VPC CNI托管加载项
    </span>
  </a>
  
    <nav class="md-nav" aria-label="部署VPC CNI托管加载项">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      迁移到托管加载项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cni" class="md-nav__link">
    <span class="md-ellipsis">
      更新前备份CNI设置
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      了解安全上下文
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cniiam" class="md-nav__link">
    <span class="md-ellipsis">
      为CNI使用单独的IAM角色
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      处理存活/就绪探测失败
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eksamiiptables" class="md-nav__link">
    <span class="md-ellipsis">
      在非EKS优化AMI实例上配置IPTables转发策略
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cni_1" class="md-nav__link">
    <span class="md-ellipsis">
      定期升级CNI版本
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ip-optimization-strategies/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimizing IP Address Utilization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ipv6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    运行 IPv6 集群
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../custom-networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    自定义网络
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prefix-mode/index_linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux 前缀模式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prefix-mode/index_windows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows 前缀模式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sgpp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    每个 Pod 的安全组
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../loadbalancing/loadbalancing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    负载均衡
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../monitoring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    监控网络性能问题
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    可扩展性
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            可扩展性
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scalability/docs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scalability/docs/control-plane/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    控制平面
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scalability/docs/data-plane/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    数据平面
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scalability/docs/cluster-services/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    集群服务
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scalability/docs/workloads/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工作负载
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scalability/docs/scaling_theory/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    扩展背后的理论
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scalability/docs/kcp_monitoring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    控制平面监控
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scalability/docs/node_efficiency/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    节点效率和扩展
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scalability/docs/kubernetes_slos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubernetes SLOs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scalability/docs/quotas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    已知限制和服务配额
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../upgrades/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    集群升级
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    成本优化
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            成本优化
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cost_optimization/cfm_framework/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    云财务管理框架
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cost_optimization/cost_opt_compute/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    计算
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cost_optimization/cost_opt_networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    网络
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cost_optimization/cost_opt_storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    存储
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cost_optimization/cost_opt_observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    可观察性
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      概述
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      建议
    </span>
  </a>
  
    <nav class="md-nav" aria-label="建议">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vpc-cni" class="md-nav__link">
    <span class="md-ellipsis">
      部署VPC CNI托管加载项
    </span>
  </a>
  
    <nav class="md-nav" aria-label="部署VPC CNI托管加载项">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      迁移到托管加载项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cni" class="md-nav__link">
    <span class="md-ellipsis">
      更新前备份CNI设置
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      了解安全上下文
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cniiam" class="md-nav__link">
    <span class="md-ellipsis">
      为CNI使用单独的IAM角色
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      处理存活/就绪探测失败
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eksamiiptables" class="md-nav__link">
    <span class="md-ellipsis">
      在非EKS优化AMI实例上配置IPTables转发策略
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cni_1" class="md-nav__link">
    <span class="md-ellipsis">
      定期升级CNI版本
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="amazon-vpc-cni">Amazon VPC CNI<a class="headerlink" href="#amazon-vpc-cni" title="Permanent link">&para;</a></h1>
<iframe width="560" height="315" src="https://www.youtube.com/embed/RBE3yk2UlYA" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

<p>Amazon EKS通过<a href="https://github.com/aws/amazon-vpc-cni-k8s">Amazon VPC Container Network Interface</a><a href="https://github.com/aws/amazon-vpc-cni-k8s">(VPC CNI)</a>插件实现集群网络。CNI插件允许Kubernetes Pods拥有与VPC网络上相同的IP地址。更具体地说,Pod内的所有容器共享一个网络命名空间,它们可以使用本地端口相互通信。</p>
<p>Amazon VPC CNI有两个组件:</p>
<ul>
<li>CNI二进制文件,用于设置Pod网络以实现Pod到Pod的通信。CNI二进制文件在节点根文件系统上运行,当新的Pod添加到节点或从节点中删除现有Pod时,kubelet会调用它。</li>
<li>ipamd,一个长期运行的节点本地IP地址管理(IPAM)守护进程,负责:</li>
<li>管理节点上的ENI,以及</li>
<li>维护可用IP地址或前缀的预热池</li>
</ul>
<p>当创建实例时,EC2会创建并附加一个与主子网关联的主ENI。主子网可以是公有或私有的。在hostNetwork模式下运行的Pods使用分配给节点主ENI的主IP地址,并与主机共享相同的网络命名空间。</p>
<p>CNI插件管理节点上的<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html">弹性网络接口(ENI)</a>。当节点配置时,CNI插件会自动从节点的子网中为主ENI分配一个IP地址池。这个池被称为<em>预热池</em>,其大小由节点的实例类型决定。根据CNI设置,一个槽可以是一个IP地址或一个前缀。当一个ENI上的槽被分配后,CNI可能会附加额外的ENI,并为这些ENI分配预热池。这些额外的ENI称为辅助ENI。每个ENI只能支持一定数量的槽,这取决于实例类型。CNI会根据需要的槽数量(通常对应于Pods的数量)附加更多ENI到实例上。这个过程一直持续,直到节点无法再支持额外的ENI。CNI还会预先分配"预热"ENI和槽,以加快Pod启动。请注意,每种实例类型都有最大的ENI数量。这是Pod密度(每个节点的Pod数量)的一个限制因素,除了计算资源之外。</p>
<p><img alt="流程图说明了需要新的ENI委派前缀时的过程" src="../../../networking/vpc-cni/image.png" /></p>
<p>每种EC2实例类型支持的网络接口数量和可使用的槽数量是不同的。由于每个Pod会消耗一个槽上的IP地址,因此您可以在特定的EC2实例上运行的Pods数量取决于可以附加到该实例的ENI数量以及每个ENI支持的槽数。我们建议将EKS用户指南中的最大Pods设置为上限,以避免耗尽实例的CPU和内存资源。使用<code>hostNetwork</code>的Pods不包括在此计算中。您可以考虑使用名为<a href="https://github.com/awslabs/amazon-eks-ami/blob/master/files/max-pods-calculator.sh">max-pod-calculator.sh</a>的脚本来计算EKS推荐的特定实例类型的最大Pods数量。</p>
<h2 id="_1">概述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>辅助IP模式是VPC CNI的默认模式。本指南提供了在启用辅助IP模式时VPC CNI行为的一般概述。ipamd的功能(IP地址分配)可能会根据VPC CNI的配置设置而有所不同,例如<a href="../prefix-mode/index_linux/">前缀模式</a>、<a href="../sgpp/">每个Pod的安全组</a>和<a href="../custom-networking/">自定义网络</a>。</p>
<p>Amazon VPC CNI被部署为名为aws-node的Kubernetes Daemonset,运行在工作节点上。当工作节点配置时,它会附加一个默认的ENI,称为主ENI。CNI从附加到节点主ENI的子网中分配一个预热池的ENI和辅助IP地址。默认情况下,ipamd会尝试为节点分配一个额外的ENI。当一个Pod被调度并从主ENI分配一个辅助IP地址时,IPAMD会分配另一个ENI。这个"预热"ENI可以实现更快的Pod网络。当辅助IP地址池耗尽时,CNI会添加另一个ENI来分配更多地址。</p>
<p>ENI和IP地址池的数量通过名为<a href="https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/eni-and-ip-target.md">WARM_ENI_TARGET、WARM_IP_TARGET、MINIMUM_IP_TARGET</a>的环境变量进行配置。<code>aws-node</code> Daemonset将定期检查是否有足够的ENI附加。当满足所有<code>WARM_ENI_TARGET</code>或<code>WARM_IP_TARGET</code>和<code>MINIMUM_IP_TARGET</code>条件时,就认为有足够的ENI附加。如果附加的ENI不足,CNI将调用EC2 API来附加更多ENI,直到达到<code>MAX_ENI</code>限制。</p>
<ul>
<li><code>WARM_ENI_TARGET</code> - 整数,值&gt;0表示要求启用</li>
<li>要维护的预热ENI数量。当一个ENI作为辅助ENI附加到节点上,但没有被任何Pod使用时,它就处于"预热"状态。更具体地说,ENI的IP地址都没有被分配给Pod。</li>
<li>例如:考虑一个实例有2个ENI,每个ENI支持5个IP地址。WARM_ENI_TARGET设置为1。如果正好有5个IP地址与该实例关联,CNI会维护2个附加到该实例的ENI。第一个ENI正在使用,所有5个可能的IP地址都在使用。第二个ENI是"预热"的,所有5个IP地址都在池中。如果在该实例上启动另一个Pod,需要第6个IP地址。CNI将从第二个ENI的池中分配这第6个IP地址。第二个ENI现在正在使用,不再处于"预热"状态。CNI将分配第3个ENI,以维持至少1个预热ENI。</li>
</ul>
<div class="admonition 注意">
<p class="admonition-title">注意</p>
<p>预热ENI仍然会消耗来自VPC CIDR的IP地址。IP地址在被工作负载(如Pod)关联之前是"未使用"或"预热"的。</p>
</div>
<ul>
<li><code>WARM_IP_TARGET</code>,整数,值&gt;0表示要求启用</li>
<li>要维护的预热IP地址数量。预热IP可用于已积极附加的ENI,但尚未分配给Pod。换句话说,可用的预热IP数量是可以分配给Pod而无需附加额外ENI的IP数量。</li>
<li>例如:考虑一个实例有1个ENI,每个ENI支持20个IP地址。WARM_IP_TARGET设置为5。WARM_ENI_TARGET设置为0。只会附加1个ENI,直到需要第16个IP地址。然后,CNI将附加第二个ENI,从子网CIDR中消耗20个可能的地址。</li>
<li><code>MINIMUM_IP_TARGET</code>,整数,值&gt;0表示要求启用</li>
<li>任何时候都要分配的最小IP地址数量。这通常用于在实例启动时预先分配多个ENI。</li>
<li>例如:考虑一个新启动的实例。它有1个ENI,每个ENI支持10个IP地址。MINIMUM_IP_TARGET设置为100。ENI立即附加9个更多ENI,总共有100个地址。这种情况发生,不管WARM_IP_TARGET或WARM_ENI_TARGET的值是什么。</li>
</ul>
<p>该项目包括一个<a href="../../../networking/subnet-calc/subnet-calc.xlsx">子网计算器Excel文档</a>。该计算器文档模拟了在不同的ENI配置选项(如<code>WARM_IP_TARGET</code>和<code>WARM_ENI_TARGET</code>)下指定工作负载的IP地址消耗情况。</p>
<p><img alt="说明分配IP地址到Pod的组件" src="../../../networking/vpc-cni/image-2.png" /></p>
<p>当Kubelet收到添加Pod的请求时,CNI二进制文件会查询ipamd获取可用的IP地址,ipamd然后将其提供给Pod。CNI二进制文件连接主机和Pod网络。</p>
<p>默认情况下,部署在节点上的Pods被分配与主ENI相同的安全组。或者,Pods也可以配置不同的安全组。</p>
<p><img alt="第二个说明分配IP地址到Pod的组件" src="../../../networking/vpc-cni/image-3.png" /></p>
<p>当IP地址池耗尽时,插件会自动附加另一个弹性网络接口到实例,并为该接口分配另一组辅助IP地址。这个过程一直持续,直到节点无法再支持额外的弹性网络接口。</p>
<p><img alt="第三个说明分配IP地址到Pod的组件" src="../../../networking/vpc-cni/image-4.png" /></p>
<p>当一个Pod被删除时,VPC CNI会将Pod的IP地址放入一个30秒的冷却缓存。冷却缓存中的IP地址不会分配给新的Pods。冷却期结束后,VPC CNI会将Pod IP移回预热池。冷却期可以防止Pod IP地址过早被回收,并允许集群中所有节点上的kube-proxy更新iptables规则。当IP或ENI的数量超过预热池设置的数量时,ipamd插件会将IP和ENI返回给VPC。</p>
<p>如上所述的辅助IP模式中,每个Pod从附加到实例的ENI之一获得一个辅助私有IP地址。由于每个Pod使用一个IP地址,因此您可以在特定的EC2实例上运行的Pods数量取决于可以附加到该实例的ENI数量以及它支持的IP地址数量。VPC CNI会检查<a href="https://github.com/aws/amazon-vpc-resource-controller-k8s/blob/master/pkg/aws/vpc/limits.go">限制</a>文件,以了解每种实例类型允许的ENI和IP地址数量。</p>
<p>您可以使用以下公式来确定可以部署在节点上的最大Pods数量。</p>
<p><code>(实例类型的网络接口数量 × (每个网络接口的IP地址数量 - 1)) + 2</code></p>
<p>+2表示使用主机网络的Pods,如kube-proxy和VPC CNI。Amazon EKS要求kube-proxy和VPC CNI在每个节点上运行,这些要求被纳入max-pods值。如果您想运行更多使用主机网络的Pods,请考虑更新max-pods值。</p>
<p>+2表示使用主机网络的Kubernetes Pods,如kube-proxy和VPC CNI。Amazon EKS要求kube-proxy和VPC CNI在每个节点上运行,并将其计算在max-pods中。如果您计划运行更多使用主机网络的Pods,请考虑更新max-pods。您可以在启动模板的用户数据中指定<code>--kubelet-extra-args "—max-pods=110"</code>。</p>
<p>例如,在一个有3个c5.large节点(3个ENI,每个ENI最多10个IP)的集群中,当集群启动并有2个CoreDNS Pods时,CNI将消耗49个IP地址并将它们保持在预热池中。预热池可以在部署应用程序时实现更快的Pod启动。</p>
<p>节点1(有CoreDNS Pod):2个ENI,分配20个IP</p>
<p>节点2(有CoreDNS Pod):2个ENI,分配20个IP</p>
<p>节点3(无Pod):1个ENI,分配10个IP。</p>
<p>请记住,作为Daemonset运行的基础设施Pods也会计入max-pod计数。这些可能包括:</p>
<ul>
<li>CoreDNS</li>
<li>Amazon Elastic LoadBalancer</li>
<li>指标服务器的操作Pods</li>
</ul>
<p>我们建议您通过结合这些Pods的容量来规划您的基础设施。有关每种实例类型支持的最大Pods数量,请参见GitHub上的<a href="https://github.com/awslabs/amazon-eks-ami/blob/master/files/eni-max-pods.txt">eni-max-Pods.txt</a>。</p>
<p><img alt="说明多个ENI附加到节点的插图" src="../../../networking/vpc-cni/image-5.png" /></p>
<h2 id="_2">建议<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="vpc-cni">部署VPC CNI托管加载项<a class="headerlink" href="#vpc-cni" title="Permanent link">&para;</a></h3>
<p>在配置集群时,Amazon EKS会自动安装VPC CNI。但是,Amazon EKS支持托管加载项,使集群能够与底层AWS资源(如计算、存储和网络)进行交互。我们强烈建议您使用托管加载项(包括VPC CNI)部署集群。</p>
<p>Amazon EKS托管加载项提供VPC CNI的安装和管理功能。Amazon EKS加载项包含最新的安全补丁、错误修复,并经AWS验证可与Amazon EKS配合使用。VPC CNI加载项使您能够持续确保Amazon EKS集群的安全性和稳定性,并减少安装、配置和更新加载项所需的工作量。此外,托管加载项可通过Amazon EKS API、AWS Management Console、AWS CLI和eksctl添加、更新或删除。</p>
<p>您可以使用<code>--show-managed-fields</code>标志与<code>kubectl get</code>命令查找VPC CNI的托管字段。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>kubectl get daemonset aws-node --show-managed-fields -n kube-system -o yaml
</code></pre></div>
<p>托管加载项通过每15分钟自动覆盖配置来防止配置偏差。这意味着,通过Kubernetes API在加载项创建后对托管加载项进行的任何更改,都将被自动防止偏差的过程覆盖,并在加载项更新过程中设置为默认值。</p>
<p>由EKS管理的字段列在managedFields下,manager为EKS。EKS管理的字段包括服务帐户、镜像、镜像URL、存活探测、就绪探测、标签、卷和卷挂载。</p>
<div class="admonition 信息">
<p class="admonition-title">信息</p>
</div>
<p>最常用的字段,如WARM_ENI_TARGET、WARM_IP_TARGET和MINIMUM_IP_TARGET,不受管理,更新时不会被重置。对这些字段的更改将在加载项更新时保留。</p>
<p>我们建议在更新生产集群之前,先在非生产集群中测试加载项行为以了解特定配置。此外,请遵循EKS用户指南中关于<a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-add-ons.html">加载项</a>配置的步骤。</p>
<h4 id="_3">迁移到托管加载项<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<p>您将管理自管理VPC CNI的版本兼容性和更新安全补丁。要更新自管理加载项,您必须使用Kubernetes API和<a href="https://docs.aws.amazon.com/eks/latest/userguide/managing-vpc-cni.html#updating-vpc-cni-add-on">EKS用户指南</a>中概述的说明。我们建议在迁移到托管加载项之前,先备份当前的CNI设置。要配置托管加载项,您可以使用Amazon EKS API、AWS Management Console或AWS命令行界面。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>kubectl apply view-last-applied daemonset aws-node -n kube-system &gt; aws-k8s-cni-old.yaml
</code></pre></div>
<p>如果字段被列为托管,Amazon EKS将用默认设置替换CNI配置设置。我们警告不要修改托管字段。加载项不会协调诸如<em>预热</em>环境变量和CNI模式之类的配置字段。在迁移到托管CNI时,Pods和应用程序将继续运行。</p>
<h4 id="cni">更新前备份CNI设置<a class="headerlink" href="#cni" title="Permanent link">&para;</a></h4>
<p>VPC CNI在客户数据平面(节点)上运行,因此当发布新版本或<a href="https://docs.aws.amazon.com/eks/latest/userguide/update-cluster.html">更新集群</a>到新的Kubernetes次版本时,Amazon EKS不会自动更新加载项(托管和自管理)。要更新现有集群的加载项,您必须通过update-addon API或在EKS控制台上单击加载项的"更新"链接来触发更新。如果您部署了自管理加载项,请遵循<a href="https://docs.aws.amazon.com/eks/latest/userguide/managing-vpc-cni.html#updating-vpc-cni-add-on">更新自管理VPC CNI加载项</a>中提到的步骤。</p>
<p>我们强烈建议您一次只更新一个次版本。例如,如果您当前的次版本是<code>1.9</code>,并且想要更新到<code>1.11</code>,您应该先更新到<code>1.10</code>的最新补丁版本,然后再更新到<code>1.11</code>的最新补丁版本。</p>
<p>在更新Amazon VPC CNI之前,请检查aws-node Daemonset。备份现有设置。如果使用托管加载项,请确认您没有更新任何Amazon EKS可能覆盖的设置。我们建议在自动化工作流程中添加更新后的挂钩,或在加载项更新后手动应用步骤。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>kubectl apply view-last-applied daemonset aws-node -n kube-system &gt; aws-k8s-cni-old.yaml
</code></pre></div>
<p>对于自管理加载项,请将备份与GitHub上的<code>releases</code>进行比较,以查看可用版本并熟悉您想要更新到的版本中的更改。我们建议使用Helm来管理自管理加载项,并利用值文件来应用设置。任何涉及Daemonset删除的更新操作都会导致应用程序停机,必须避免。</p>
<h3 id="_4">了解安全上下文<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>我们强烈建议您了解用于有效管理VPC CNI的配置的安全上下文。Amazon VPC CNI有两个组件:CNI二进制文件和ipamd(aws-node)Daemonset。CNI作为二进制文件在节点上运行,并访问节点根文件系统,同时还具有特权访问权限,因为它处理节点级别的iptables。当Pods被添加或删除时,kubelet会调用CNI二进制文件。</p>
<p>aws-node Daemonset是一个长期运行的进程,负责在节点级别管理IP地址。aws-node在<code>hostNetwork</code>模式下运行,允许访问回环设备和同一节点上其他Pods的网络活动。aws-node init容器以特权模式运行,并挂载CRI套接字,允许Daemonset监视在节点上运行的Pods的IP使用情况。Amazon EKS正在努力消除aws-node init容器的特权要求。此外,aws-node需要更新NAT条目,并加载iptables模块,因此以NET_ADMIN特权运行。</p>
<p>Amazon EKS建议部署如aws-node清单所定义的安全策略,用于Pods的IP管理和网络设置。请考虑更新到最新版本的VPC CNI。此外,如果您有特定的安全要求,请考虑在<a href="https://github.com/aws/amazon-vpc-cni-k8s/issues">GitHub问题</a>中提出。</p>
<h3 id="cniiam">为CNI使用单独的IAM角色<a class="headerlink" href="#cniiam" title="Permanent link">&para;</a></h3>
<p>AWS VPC CNI需要AWS Identity and Access Management (IAM)权限。在使用IAM角色之前,需要设置CNI策略。您可以使用<a href="https://console.aws.amazon.com/iam/home#/policies/arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy%24jsonEditor"><code>AmazonEKS_CNI_Policy</code></a>,这是一个用于IPv4集群的AWS托管策略。AmazonEKS CNI托管策略只有IPv4集群的权限。您必须为IPv6集群创建一个单独的IAM策略,权限列表<a href="https://docs.aws.amazon.com/eks/latest/userguide/cni-iam-role.html#cni-iam-role-create-ipv6-policy">在此</a>。</p>
<p>默认情况下,VPC CNI继承<a href="https://docs.aws.amazon.com/eks/latest/userguide/create-node-role.html">Amazon EKS节点IAM角色</a>(托管和自管理节点组)。</p>
<p><strong>强烈</strong>建议为Amazon VPC CNI配置一个单独的IAM角色。否则,Amazon VPC CNI的Pods将获得分配给节点IAM角色的权限,并访问分配给节点的实例配置文件。</p>
<p>VPC CNI插件创建并配置了一个名为aws-node的服务帐户。默认情况下,该服务帐户绑定到附有Amazon EKS CNI策略的Amazon EKS节点IAM角色。要使用单独的IAM角色,我们建议<a href="https://docs.aws.amazon.com/eks/latest/userguide/cni-iam-role.html#cni-iam-role-create-role">创建一个新的服务帐户</a>,并附加Amazon EKS CNI策略。要使用新的服务帐户,您必须<a href="https://docs.aws.amazon.com/eks/latest/userguide/cni-iam-role.html#cni-iam-role-redeploy-pods">重新部署CNI Pods</a>。在创建新集群时,请考虑为VPC CNI托管加载项指定<code>--service-account-role-arn</code>。确保从Amazon EKS节点角色中删除Amazon EKS CNI策略,包括IPv4和IPv6。</p>
<p>建议<a href="https://aws.github.io/aws-eks-best-practices/security/docs/iam/#restrict-access-to-the-instance-profile-assigned-to-the-worker-node">阻止对实例元数据的访问</a>,以最小化安全漏洞的影响范围。</p>
<h3 id="_5">处理存活/就绪探测失败<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>我们建议增加存活和就绪探测超时值(默认<code>timeoutSeconds: 10</code>)以防止EKS 1.20及更高版本集群上的探测失败导致应用程序的Pod陷入containerCreating状态。这个问题在数据密集型和批处理集群中有所发现。高CPU使用会导致aws-node探测健康失败,从而无法满足Pod的CPU请求。除了修改探测超时,还要确保正确配置了aws-node的CPU资源请求(默认<code>CPU: 25m</code>)。除非您的节点出现问题,否则我们不建议更新这些设置。</p>
<p>我们强烈鼓励您在与Amazon EKS支持人员交流时,在节点上运行sudo <code>bash /opt/cni/bin/aws-cni-support.sh</code>。该脚本将帮助评估节点上的kubelet日志和内存利用率。请考虑在Amazon EKS工作节点上安装SSM Agent以运行该脚本。</p>
<h3 id="eksamiiptables">在非EKS优化AMI实例上配置IPTables转发策略<a class="headerlink" href="#eksamiiptables" title="Permanent link">&para;</a></h3>
<p>如果您使用自定义AMI,请确保在<a href="https://github.com/awslabs/amazon-eks-ami/blob/master/files/kubelet.service#L8">kubelet.service</a>下将iptables转发策略设置为ACCEPT。许多系统将iptables转发策略设置为DROP。您可以使用<a href="https://packer.io/intro/why.html">HashiCorp Packer</a>和来自<a href="https://github.com/awslabs/amazon-eks-ami">AWS GitHub上的Amazon EKS AMI存储库</a>的构建规范和配置脚本来构建自定义AMI。您可以更新<a href="https://github.com/awslabs/amazon-eks-ami/blob/master/files/kubelet.service#L8">kubelet.service</a>,并按照<a href="https://aws.amazon.com/premiumsupport/knowledge-center/eks-custom-linux-ami/">此处</a>指定的说明创建自定义AMI。</p>
<h3 id="cni_1">定期升级CNI版本<a class="headerlink" href="#cni_1" title="Permanent link">&para;</a></h3>
<p>VPC CNI是向后兼容的。最新版本适用于所有Amazon EKS支持的Kubernetes版本。此外,VPC CNI作为EKS加载项提供(请参见上面的"部署VPC CNI托管加载项")。虽然EKS加载项编排了加载项的升级,但它不会自动升级像CNI这样的加载项,因为它们运行在数据平面上。您有责任在工作节点升级后升级VPC CNI加载项。</p>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["tabs", "content.code.copy", "announce.dismiss", "header.autohide"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
    
  </body>
</html>